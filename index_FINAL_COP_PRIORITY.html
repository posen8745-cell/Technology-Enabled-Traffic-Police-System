<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>T字路口｜科技交警版（最終可示範）</title>
<style>
/* --- UI styles trimmed for brevity but functional --- */
body{margin:0;background:#0b1220;color:#e8eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto}
.wrap{display:grid;grid-template-columns:1fr 420px;gap:14px;padding:14px}
.card{border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.25)}
.canvasWrap{padding:10px}
canvas{width:100%;height:640px;border-radius:12px;background:rgba(0,0,0,.2)}
.panel{padding:12px}
button{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#1a2338;color:#e8eefc;cursor:pointer}
button.danger{background:#5a1420}
.row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">
  <div class="card canvasWrap"><canvas id="c"></canvas></div>
  <div class="card panel">
    <div class="row"><b>科技交警 Demo（最終）</b></div>
    <div class="row">
      <button id="demoJam" class="danger">Demo：塞車介入</button>
      <button id="reset">重置</button>
    </div>
    <div class="row"><span>Phase</span><span id="phase" class="mono">--</span></div>
    <div class="row"><span>科技交警</span><span id="cop" class="mono">待命</span></div>
  </div>
</div>

<script>
/* ================= Core Minimal Engine (Demo-Focused) ================= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
function resize(){const dpr=window.devicePixelRatio||1;const r=canvas.getBoundingClientRect();canvas.width=r.width*dpr;canvas.height=r.height*dpr;ctx.setTransform(dpr,0,0,dpr,0,0)}
resize();addEventListener('resize',resize);

const PH={AR:'AR',M1S_G:'M1S_G',PSEQ:'PSEQ'};
let phase=PH.AR, remaining=1, simSec=0;

const CTRL={COP_MAX_GREEN_BOOST:20,M1S_MAX:50};
let cop={stage:0,active:false,targetKey:null,boostedMax:null,reason:''};

function geom(){return {W:canvas.width,H:canvas.height}}
function drawRoad(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='rgba(255,255,255,.2)';ctx.strokeRect(40,200,canvas.width-80,120)}
function drawCars(){}
function signals(){return {}}
function updateUI(){document.getElementById('phase').textContent=phase;document.getElementById('cop').textContent=cop.active?'救援中':'待命'}

function copDecide(){ // Demo: force Stage2 after a few seconds
  if(simSec>5){cop.stage=2;return {key:'M1S',reason:'Demo force'}}
  return null;
}

function enterPhase(p){phase=p;remaining=3}

function tick1s(){
  simSec++; remaining--;
  if(remaining>0) return;
  if(phase===PH.AR){
    // ===== COP Stage2 priority =====
    const d=copDecide();
    if(d && cop.stage===2){
      cop.active=true; cop.targetKey=d.key;
      cop.boostedMax=CTRL.M1S_MAX+CTRL.COP_MAX_GREEN_BOOST;
      enterPhase(PH.M1S_G); return;
    }
    enterPhase(PH.PSEQ); return;
  }
  enterPhase(PH.AR);
}

setInterval(tick1s,1000);

let last=performance.now();
function loop(t){
  const dt=(t-last)/1000; last=t;
  drawRoad(); drawCars(); updateUI();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Demo button
document.getElementById('demoJam').onclick=()=>{simSec=6};
document.getElementById('reset').onclick=()=>{simSec=0;cop.active=false;cop.stage=0;enterPhase(PH.AR)};
</script>
</body>
</html>
